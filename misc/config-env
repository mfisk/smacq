#!/bin/sh

has() {
	which "$1" > /dev/null 2>&1
}

config() {
	LIBTOOL=${LIBTOOL:-libtool}
	USR=${USR:-/usr}
	LDXX=${LDXX:-g++}
	DOCBOOK2MAN=${DOCBOOK2MAN:-docbook-to-man}
	CFLAGS="-D_ISOC99_SOURCE -D_GNU_SOURCE" #To get NAN, among other things
	CFLAGS="${CFLAGS} -DSMACQ_BUILD_DATE='\"`date --iso-8601`\"'"
	CC=cc

	if [ `uname -s` = "Darwin" ]; then 
		echo 'MAKE=gnumake'
		LIBTOOL=glibtool
		LDOPTS="${LDOPTS}-L/lib -L/usr/lib -L/sw/lib -ldl"
		CFLAGS="${CFLAGS}-I/usr/include -I/sw/include "
		USR="/sw/"

	elif [ `uname -s` = "FreeBSD" ]; then
		echo 'MAKE=gmake'
		USR="/usr/local/"
		LDOPTS="${LDOPTS}-L/usr/local/lib -liconv -lintl"
		echo 'M4=gm4'

	elif [ `uname -s` = "Linux" ]; then
		# Red Hat 8.0: 
		if has g++296; then 
			LDXX="--mode=link g++296"
			echo 'CXX=--mode=compile g++296'
		fi 
		if has gcc296; then 
			echo 'CC=gcc296'
		fi 

		##
		## Some poor RedHat users had a busted gcc-3.3 that resulted
		## in a parser tha couldn't parse anything. 
		## However, I have success with:
		## 	gcc version 3.3.2 20030812 (Debian prerelease)
		## So I won't avoid gcc-3.3 completely.
		##
		#if has gcc-3.3; then
		#	if has gcc-3.2; then
		#		echo 'Using gcc-3.2 instead of 3.3' >&2
		#		#echo 'CC=gcc-3.2'
		#	else 
		#		echo 'Cannot use gcc 3.3' >&2
		#		exit 1
		#	fi
		#fi

		# gcc-3.3.2 can't inline things that gcc-3.2.3 seems to
		if $CC --version | grep -q ' 3\.3'; then
			if has gcc-3.2; then
				echo 'Using gcc-3.2 instead of 3.3' >&2
				CC=gcc-3.2
			fi
		fi

		# Red Hat 7.3: 
		if [ -d /usr/include/pcap ]; then 
			CFLAGS="${CFLAGS}-I/usr/include/pcap "
		fi 

		# Red Hat:
		if [ \! -f /usr/bin/docbook-to-man -a -f /usr/bin/docbook2man ]; then
			DOCBOOK2MAN=docbook2man
		fi

		LDOPTS="${LDOPTS}-ldl"
		
	fi 

	PWD=`pwd`

	echo "DOCBOOK2MAN=$DOCBOOK2MAN"
	echo "LIBTOOL=$LIBTOOL"
	echo "LDXX=$LDXX"
	echo "USR=$USR"
	echo "LDOPTS=$LDOPTS"
	echo "CC=$CC"
	echo "CFLAGS=$CFLAGS"
	echo "MAKEINCLUDES=$PWD/misc/include.mk"
	echo "TOPSRCDIR=${TOPSRCDIR:-$PWD}"
	echo "SRCDIR=$PWD"
	echo "VPATH=$PWD"
	echo "TOPBINDIR=${TOPBINDIR:-$PWD/build/$platform}"
	echo "BINDIR=$PWD/build/$platform"
	echo "include $PWD/misc/include.mk"
}

platform=`uname -sm| sed 's/  */-/g'`
mkdir -p build/$platform
config > build/$platform/config.mk
